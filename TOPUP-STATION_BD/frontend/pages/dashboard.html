<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - TopUp Station BD</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <i class="fas fa-gem"></i>
        <span>TopUp Station BD</span>
      </div>
      <div class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="topup.html">Top-Up</a>
        <a href="wallet.html">Wallet</a>
        <a href="transactions.html">Transactions</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="container">
      <div class="dashboard-header">
        <h1>Welcome, <span id="userName">User</span></h1>
        <p>Manage your account and top-ups</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-wallet"></i></div>
          <div class="stat-info">
            <h3>Wallet Balance</h3>
            <p class="stat-value">à§³<span id="walletBalance">0</span></p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
          <div class="stat-info">
            <h3>Total Orders</h3>
            <p class="stat-value"><span id="totalOrders">0</span></p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-gem"></i></div>
          <div class="stat-info">
            <h3>Total Diamonds</h3>
            <p class="stat-value"><span id="totalDiamonds">0</span></p>
          </div>
        </div>
      </div>

      <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
          <a href="topup.html" class="action-btn">
            <i class="fas fa-gamepad"></i>
            <span>Buy Diamonds</span>
          </a>
          <a href="wallet.html" class="action-btn">
            <i class="fas fa-plus-circle"></i>
            <span>Add Funds</span>
          </a>
          <a href="transactions.html" class="action-btn">
            <i class="fas fa-history"></i>
            <span>View History</span>
          </a>
        </div>
      </div>

      <div class="recent-orders">
        <h2>Recent Orders</h2>
        <div id="recentOrdersList"></div>
      </div>
    </div>
  </div>

  <script src="../js/main.js"></script>
  <script>
    const API_URL = 'http://localhost:5000/api';

    async function loadDashboard() {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      document.getElementById('userName').textContent = user.username || 'User';

      try {
        // Load wallet balance
        const walletRes = await fetch(`${API_URL}/wallet/balance`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const walletData = await walletRes.json();
        if (walletData.success) {
          document.getElementById('walletBalance').textContent = walletData.balance;
        }

        // Load recent orders
        const ordersRes = await fetch(`${API_URL}/topup/history`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const ordersData = await ordersRes.json();
        if (ordersData.success) {
          document.getElementById('totalOrders').textContent = ordersData.count;
          const totalDiamonds = ordersData.topUps
            .filter(o => o.status === 'completed')
            .reduce((sum, o) => sum + o.package.diamonds, 0);
          document.getElementById('totalDiamonds').textContent = totalDiamonds;
          displayRecentOrders(ordersData.topUps.slice(0, 5));
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    function displayRecentOrders(orders) {
      const container = document.getElementById('recentOrdersList');
      if (orders.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#aaa;">No orders yet</p>';
        return;
      }

      container.innerHTML = orders.map(order => `
                <div class="order-item">
                    <div class="order-info">
                        <span class="order-diamonds">${order.package.diamonds} ðŸ’Ž</span>
                        <span class="order-uid">UID: ${order.freeFireUID}</span>
                    </div>
                    <div class="order-status status-${order.status}">${order.status}</div>
                </div>
            `).join('');
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '../index.html';
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>

</html>